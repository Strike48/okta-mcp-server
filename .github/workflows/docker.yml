name: Docker Build

on:
    push:
        branches: [main, develop, 'feat/**', 'bugfix/**']
    workflow_dispatch:

jobs:
    docker:
        name: Build & Push Multi-Arch
        runs-on: ubuntu-latest

        permissions:
            contents: read
            packages: write

        steps:
            - uses: actions/checkout@v4

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata
              id: meta
              run: |
                  DATE_TAG=$(date -u +'%Y-%m-%d')-${GITHUB_SHA:0:8}
                  BRANCH=${GITHUB_REF##*/}
                  IMAGE="ghcr.io/${{ github.repository }}"
                  IMAGE=$(echo "$IMAGE" | tr '[:upper:]' '[:lower:]')

                  echo "image=${IMAGE}" >> $GITHUB_OUTPUT
                  echo "date_tag=${DATE_TAG}" >> $GITHUB_OUTPUT
                  echo "branch=${BRANCH}" >> $GITHUB_OUTPUT

            - name: Build and push stdio variant (default)
              uses: docker/build-push-action@v5
              with:
                  context: .
                  target: stdio
                  platforms: linux/amd64,linux/arm64
                  push: true
                  tags: |
                      ${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.date_tag }}-stdio
                      ${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.branch }}-stdio
                      ${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.date_tag }}
                      ${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.branch }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Build and push http variant
              uses: docker/build-push-action@v5
              with:
                  context: .
                  target: http
                  platforms: linux/amd64,linux/arm64
                  push: true
                  tags: |
                      ${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.date_tag }}-http
                      ${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.branch }}-http
                  cache-from: type=gha

            - name: Build and push sse variant
              uses: docker/build-push-action@v5
              with:
                  context: .
                  target: sse
                  platforms: linux/amd64,linux/arm64
                  push: true
                  tags: |
                      ${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.date_tag }}-sse
                      ${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.branch }}-sse
                  cache-from: type=gha

            - name: Push latest tag for main branch
              if: github.ref == 'refs/heads/main'
              uses: docker/build-push-action@v5
              with:
                  context: .
                  target: stdio
                  platforms: linux/amd64,linux/arm64
                  push: true
                  tags: |
                      ${{ steps.meta.outputs.image }}:latest
                      ${{ steps.meta.outputs.image }}:latest-stdio
                  cache-from: type=gha

            - name: Push latest http tag for main branch
              if: github.ref == 'refs/heads/main'
              uses: docker/build-push-action@v5
              with:
                  context: .
                  target: http
                  platforms: linux/amd64,linux/arm64
                  push: true
                  tags: ${{ steps.meta.outputs.image }}:latest-http
                  cache-from: type=gha

            - name: Push latest sse tag for main branch
              if: github.ref == 'refs/heads/main'
              uses: docker/build-push-action@v5
              with:
                  context: .
                  target: sse
                  platforms: linux/amd64,linux/arm64
                  push: true
                  tags: ${{ steps.meta.outputs.image }}:latest-sse
                  cache-from: type=gha

            - name: Summary
              run: |
                  echo "## ðŸŽ‰ Multi-arch Docker Build Complete" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Image:** \`${{ steps.meta.outputs.image }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "**Platforms:** \`linux/amd64\`, \`linux/arm64\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Variants built:" >> $GITHUB_STEP_SUMMARY
                  echo "- \`stdio\` (default/recommended)" >> $GITHUB_STEP_SUMMARY
                  echo "- \`http\` (web applications)" >> $GITHUB_STEP_SUMMARY
                  echo "- \`sse\` (legacy)" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Tags pushed:" >> $GITHUB_STEP_SUMMARY
                  echo "- \`${{ steps.meta.outputs.date_tag }}\` (stdio default)" >> $GITHUB_STEP_SUMMARY
                  echo "- \`${{ steps.meta.outputs.date_tag }}-stdio\`" >> $GITHUB_STEP_SUMMARY
                  echo "- \`${{ steps.meta.outputs.date_tag }}-http\`" >> $GITHUB_STEP_SUMMARY
                  echo "- \`${{ steps.meta.outputs.date_tag }}-sse\`" >> $GITHUB_STEP_SUMMARY
                  echo "- \`${{ steps.meta.outputs.branch }}\` (stdio default)" >> $GITHUB_STEP_SUMMARY
                  echo "- \`${{ steps.meta.outputs.branch }}-stdio\`" >> $GITHUB_STEP_SUMMARY
                  echo "- \`${{ steps.meta.outputs.branch }}-http\`" >> $GITHUB_STEP_SUMMARY
                  echo "- \`${{ steps.meta.outputs.branch }}-sse\`" >> $GITHUB_STEP_SUMMARY
                  if [ "${{ github.ref }}" = "refs/heads/main" ]; then
                    echo "- \`latest\` (stdio default)" >> $GITHUB_STEP_SUMMARY
                    echo "- \`latest-stdio\`" >> $GITHUB_STEP_SUMMARY
                    echo "- \`latest-http\`" >> $GITHUB_STEP_SUMMARY
                    echo "- \`latest-sse\`" >> $GITHUB_STEP_SUMMARY
                  fi
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Usage:" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
                  echo "# Pull default (stdio) variant" >> $GITHUB_STEP_SUMMARY
                  echo "docker pull ${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "# Or pull specific variant" >> $GITHUB_STEP_SUMMARY
                  echo "docker pull ${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.branch }}-http" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

