name: CI

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

jobs:
    test:
        name: Test & Build
        runs-on: ubuntu-latest

        strategy:
            matrix:
                python-version: ["3.10", "3.11", "3.12", "3.13"]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}
                  cache: "pip"

            - name: Install uv
              uses: astral-sh/setup-uv@v4
              with:
                  version: "latest"

            - name: Install dependencies
              run: |
                  uv pip install --system -r requirements.txt

            - name: Lint with ruff (if available)
              run: |
                  uv pip install --system ruff || echo "Ruff not available, skipping lint"
                  ruff check . || echo "No ruff configuration, skipping"
              continue-on-error: true

            - name: Type check with mypy (if available)
              run: |
                  uv pip install --system mypy || echo "Mypy not available, skipping type check"
                  mypy okta_mcp/ || echo "No mypy configuration, skipping"
              continue-on-error: true

            - name: Verify imports
              run: python -c "import okta_mcp; print('✓ Package imports successfully')"

            - name: Build Docker image (stdio)
              run: docker build --target stdio -t okta-mcp-server:stdio .

            - name: Build Docker image (http)
              run: docker build --target http -t okta-mcp-server:http .

            - name: Build Docker image (sse)
              run: docker build --target sse -t okta-mcp-server:sse .

            - name: Docker verify
              run: |
                  docker run --rm okta-mcp-server:stdio python -c "import okta_mcp; print('✓ Docker stdio variant OK')"
                  echo "✓ All Docker variants built successfully"

            - name: Security audit
              run: |
                  uv pip install --system pip-audit || echo "pip-audit not available"
                  pip-audit --requirement requirements.txt || echo "Security audit completed with warnings"
              continue-on-error: true

